<!doctype html><html lang="es"><head>
  <%- include('../../../partials/headAdmin') %>
  <link rel="stylesheet" href="/resources/styles/styleFormsAdmins.css">
  <style>
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .stats-table{width:100%;overflow-x:auto}
    .ip-input{width:110px;font-variant-numeric:tabular-nums;letter-spacing:.2px}
  </style>
</head><body>
  <%- include('../../../partials/navbar_adminGeneral') %>
  <main class="container">
    <h1>Cargar pitcheo por equipo</h1>

    <form method="POST" action="/adminGeneral/stats/cargarPitcheoEquipo">
      <div class="card" style="padding:1rem 1.2rem">
        <div class="filters">
          <div>
            <label>Temporada *</label>
            <select id="selTemp" name="id_temporada" class="input" required>
              <% (temporadas||[]).forEach(t=>{ %>
                <option value="<%= t.id_temporada %>"><%= t.nombre %></option>
              <% }) %>
            </select>
          </div>
          <div>
            <label>Categoría *</label>
            <select id="selCat" name="id_categoria" class="input" required>
              <option value="">Selecciona</option>
            </select>
          </div>
          <div>
            <label>Equipo *</label>
            <select id="selEq" name="id_equipo_temporada" class="input" required>
              <option value="">Selecciona</option>
            </select>
          </div>
        </div>

        <div class="stats-table">
          <table>
            <thead>
              <tr>
                <th>Jugador</th><th>BB</th><th>W</th><th>L</th><th>IP</th><th>ER</th><th>SO</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="7">Selecciona filtros…</td></tr></tbody>
          </table>
        </div>

        <div class="form-actions" style="display:flex;justify-content:flex-end;gap:.8rem;margin-top:1.2rem">
          <button class="btn btn-primary" type="submit">Cargar</button>
          <a class="btn btn-outline" href="/adminGeneral/inicio">Cancelar</a>
        </div>
      </div>
    </form>
  </main>

  <script>
    const GET=u=>fetch(u,{headers:{'x-requested-with':'XMLHttpRequest'}}).then(r=>r.json());
    const $t=document.getElementById('selTemp'),$c=document.getElementById('selCat'),$e=document.getElementById('selEq'),$tb=document.getElementById('tbody');

    const row=(id,n)=>`
      <tr>
        <td>${n}<input type="hidden" name="id_jugador[]" value="${id}"></td>
        <td><input class="input" name="bases_por_bolas[]"   type="number" min="0" step="1"   value="0"></td>
        <td><input class="input" name="victorias[]"         type="number" min="0" step="1"   value="0"></td>
        <td><input class="input" name="derrotas[]"          type="number" min="0" step="1"   value="0"></td>
        <td><input class="input ip-input" name="entradas_lanzadas[]" type="number" min="0" step="0.1" value="0.0" data-ip></td>
        <td><input class="input" name="carreras_limpias[]"  type="number" min="0" step="1"   value="0"></td>
        <td><input class="input" name="ponches[]"           type="number" min="0" step="1"   value="0"></td>
      </tr>`;

    async function loadCats(){
      $c.innerHTML='<option value="">Selecciona</option>';
      $e.innerHTML='<option value="">Selecciona</option>';
      $tb.innerHTML='<tr><td colspan="7">Selecciona filtros…</td></tr>';
      const cs=await GET(`/adminGeneral/stats/categorias?id_temporada=${$t.value}`); cs.forEach(x=>{
        const o=document.createElement('option'); o.value=x.id_categoria; o.textContent=x.nombre; $c.appendChild(o);
      });
    }
    async function loadTeams(){
      $e.innerHTML='<option value="">Selecciona</option>';
      $tb.innerHTML='<tr><td colspan="7">Selecciona equipo…</td></tr>';
      const es=await GET(`/adminGeneral/stats/equipos?id_temporada=${$t.value}&id_categoria=${$c.value}`);
      es.forEach(x=>{ const o=document.createElement('option'); o.value=x.id_equipo_temporada; o.textContent=x.nombre; $e.appendChild(o); });
    }
    async function loadRoster(){
      if(!$e.value){ $tb.innerHTML='<tr><td colspan="7">Selecciona equipo…</td></tr>'; return; }
      $tb.innerHTML='<tr><td colspan="7">Cargando…</td></tr>';
      const js=await GET(`/adminGeneral/stats/plantel?id_equipo_temporada=${$e.value}`);
      if(!js.length){ $tb.innerHTML='<tr><td colspan="7">Sin plantel.</td></tr>'; return; }
      $tb.innerHTML=js.map(j=>row(j.id_jugador,j.nombre)).join('');
      document.querySelectorAll('input[data-ip]').forEach(bindIP);
    }

    // IP helpers
    const f1=x=>(Math.round(x*10)/10).toFixed(1);
    function incIP(el){const v=Math.max(0,Number(el.value)||0),b=Math.floor(v+1e-9),f=Math.round((v-b)*10); el.value=f<=0?f1(b+0.1):(f===1?f1(b+0.2):f1(b+1.0));}
    function decIP(el){const v=Math.max(0,Number(el.value)||0),b=Math.floor(v+1e-9),f=Math.round((v-b)*10); if(f>=2)el.value=f1(b+0.1); else if(f===1)el.value=f1(b+0.0); else el.value=f1((b>0?b-1:0)+(b>0?0.2:0.0));}
    function snapIP(el){let v=Math.max(0,Number(el.value)||0),b=Math.floor(v+1e-9),f=Math.round((v-b)*10); if(f<=0)f=0; else if(f===1)f=1; else if(f===2)f=2; else {b+=1;f=0;} el.value=f1(b+f/10);}
    function limitIPTyping(el){const s=el.value; if(s===''||s==='.')return; const v=Number(s); if(Number.isNaN(v)||v<0){el.value='0.0';return;} const p=s.split('.'); if(p.length===2){const d=p[1][0]??'0'; if(d>'2'){el.value=String(Number(p[0])+1); snapIP(el); return;} if(p[1].length>1) el.value=p[0]+'.'+d;}}
    function bindIP(el){snapIP(el); el.addEventListener('blur',()=>snapIP(el)); el.addEventListener('change',()=>snapIP(el)); el.addEventListener('input',()=>limitIPTyping(el)); el.addEventListener('keydown',e=>{if(e.key==='ArrowUp'){e.preventDefault();incIP(el);} if(e.key==='ArrowDown'){e.preventDefault();decIP(el);}});}

    $t.addEventListener('change',loadCats);
    $c.addEventListener('change',loadTeams);
    $e.addEventListener('change',loadRoster);
    (async function init(){ await loadCats(); })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <% if (typeof alert !== 'undefined' && alert) { %>
  <script>
    Swal.fire({
      title:<%- JSON.stringify(alertTitle) %>, text:<%- JSON.stringify(alertMessage) %>,
      icon:<%- JSON.stringify(alertIcon) %>, showConfirmButton:<%- JSON.stringify(showConfirmButton) %>,
      timer:<%- (timer==null?'null':Number(timer)) %>
    }).then(()=>{ if(<%- !!ruta %>) location.href=<%- JSON.stringify(ruta) %>; });
  </script>
  <% } %>
</body></html>
