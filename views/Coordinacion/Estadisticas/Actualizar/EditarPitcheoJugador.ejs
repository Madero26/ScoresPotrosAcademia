<!-- views/AdminEstadisticas/StatsEditarPitcheoJugador.ejs -->
<!doctype html>
<html lang="es">
<head>
  <%- include('../../../partials/headAdmin') %>
  <link rel="stylesheet" href="/resources/styles/styleFormsAdmins.css">
  <style>.ip-input{width:110px;font-variant-numeric:tabular-nums;letter-spacing:.2px}</style>
</head>
<body>
  <%- include('../../../partials/navbar_adminEstadisticas') %>

  <main class="container">
    <h1>Editar pitcheo de jugador</h1>

    <div class="card">
      <div class="form-grid">
        <div class="form-group">
          <label>Equipo</label>
          <select id="selEq" class="input">
            <option value="">Selecciona</option>
            <% (equipos||[]).forEach(e=>{ %>
              <option value="<%= e.id_equipo_temporada %>"><%= e.nombre %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label>Jugador</label>
          <input id="busc" class="input" placeholder="Busca por nombre…">
          <select id="selJug" class="input" size="6" style="margin-top:.5rem"></select>
        </div>
      </div>

      <form id="frm" method="POST" action="/adminEstadisticas/StatsEditarPitcheoJugador">
        <input type="hidden" name="id_equipo_temporada" id="id_eq">
        <input type="hidden" name="id_jugador" id="id_jug">

        <div class="form-grid">
          <div class="form-group"><label>BB</label> <input class="input" name="bases_por_bolas"   type="number" min="0" step="1"   value="0"></div>
          <div class="form-group"><label>W</label>  <input class="input" name="victorias"         type="number" min="0" step="1"   value="0"></div>
          <div class="form-group"><label>L</label>  <input class="input" name="derrotas"          type="number" min="0" step="1"   value="0"></div>
          <div class="form-group"><label>IP</label> <input class="input ip-input" name="entradas_lanzadas" type="number" min="0" step="0.1" value="0.0" data-ip></div>
          <div class="form-group"><label>ER</label> <input class="input" name="carreras_limpias"  type="number" min="0" step="1"   value="0"></div>
          <div class="form-group"><label>SO</label> <input class="input" name="ponches"           type="number" min="0" step="1"   value="0"></div>
          <div class="form-group"><label>ERA</label><input class="input" id="era" type="text" value="0.000" disabled></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" disabled id="btnSave">Guardar</button>
          <a class="btn btn-outline" href="/adminEstadisticas">Cancelar</a>
        </div>
      </form>
    </div>
  </main>

  <script>
    const selEq=document.getElementById('selEq');
    const selJug=document.getElementById('selJug');
    const busc=document.getElementById('busc');
    const id_eq=document.getElementById('id_eq');
    const id_jug=document.getElementById('id_jug');
    const btn=document.getElementById('btnSave');
    const era=document.getElementById('era');
    let full=[];

    async function loadPlantel(){
      selJug.innerHTML=''; id_eq.value=selEq.value||''; btn.disabled=true;
      if(!selEq.value) return;
      const r = await fetch(`/adminEstadisticas/ajax/pitcheoPlantel?id_equipo_temporada=${selEq.value}`);
      full = await r.json();
      renderList('');
    }
    function renderList(f){
      const q=String(f||'').toLowerCase();
      selJug.innerHTML='';
      full.filter(x=>x.nombre.toLowerCase().includes(q))
          .forEach(x=>{ const o=document.createElement('option'); o.value=x.id_jugador; o.textContent=x.nombre; selJug.appendChild(o); });
    }
    busc.addEventListener('input', e=>renderList(e.target.value));
    selEq.addEventListener('change', loadPlantel);

    selJug.addEventListener('change', async ()=>{
      id_jug.value = selJug.value || '';
      btn.disabled = !selJug.value || !selEq.value;
      if(!selJug.value) return;
      const r = await fetch(`/adminEstadisticas/ajax/pitcheoJugador?id_jugador=${selJug.value}`);
      const js = await r.json() || {};
      const set = (name,val,fmt)=>{ const el=document.querySelector(`[name="${name}"]`); if(!el) return; el.value=fmt?fmt(val):Number(val||0); };

      set('bases_por_bolas',   js.bases_por_bolas);
      set('victorias',         js.victorias);
      set('derrotas',          js.derrotas);
      set('entradas_lanzadas', js.entradas_lanzadas, v=>{ const n=Number(v||0); return (Math.round(Math.max(0,n)*10)/10).toFixed(1); });
      set('carreras_limpias',  js.carreras_limpias);
      set('ponches',           js.ponches);
      era.value = (typeof js.efectividad==='number') ? js.efectividad.toFixed(3) : '0.000';

      const ipEl=document.querySelector('input[name="entradas_lanzadas"]'); if(ipEl) snapIP(ipEl);
    });
  </script>

  <script>
    // --- IP helpers: n.0 → n.1 → n.2 → n+1.0 y reversa
    const f1 = x => (Math.round(x*10)/10).toFixed(1);
    function incIP(el){
      const v=Math.max(0,Number(el.value)||0), b=Math.floor(v+1e-9), f=Math.round((v-b)*10);
      el.value = f<=0 ? f1(b+0.1) : (f===1 ? f1(b+0.2) : f1(b+1.0));
    }
    function decIP(el){
      const v=Math.max(0,Number(el.value)||0), b=Math.floor(v+1e-9), f=Math.round((v-b)*10);
      if(f>=2) el.value=f1(b+0.1);
      else if(f===1) el.value=f1(b+0.0);
      else el.value=f1((b>0?b-1:0)+(b>0?0.2:0.0));
    }
    function snapIP(el){
      let v=Math.max(0,Number(el.value)||0), b=Math.floor(v+1e-9), f=Math.round((v-b)*10);
      if(f<=0) f=0; else if(f===1) f=1; else if(f===2) f=2; else { b+=1; f=0; }
      el.value=f1(b+f/10);
    }
    function limitIPTyping(el){
      const s=el.value; if(s===''||s==='.') return;
      const v=Number(s); if(Number.isNaN(v)||v<0){ el.value='0.0'; return; }
      const p=s.split('.'); if(p.length===2){
        const d=p[1][0]??'0';
        if(d>'2'){ el.value=String(Number(p[0])+1); snapIP(el); return; }
        if(p[1].length>1) el.value=p[0]+'.'+d;
      }
    }
    function bindIP(el){
      snapIP(el);
      el.addEventListener('blur',()=>snapIP(el));
      el.addEventListener('change',()=>snapIP(el));
      el.addEventListener('input',()=>limitIPTyping(el));
      el.addEventListener('keydown',e=>{
        if(e.key==='ArrowUp'){ e.preventDefault(); incIP(el); }
        if(e.key==='ArrowDown'){ e.preventDefault(); decIP(el); }
      });
    }
    document.querySelectorAll('input[data-ip]').forEach(bindIP);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <% if (typeof alert !== 'undefined' && alert) { %>
  <script>
    Swal.fire({
      title:<%- JSON.stringify(alertTitle) %>,
      text:<%- JSON.stringify(alertMessage) %>,
      icon:<%- JSON.stringify(alertIcon) %>,
      showConfirmButton:<%- JSON.stringify(showConfirmButton) %>,
      timer:<%- (timer==null?'null':Number(timer)) %>
    }).then(()=>{ if(<%- !!ruta %>) location.href=<%- JSON.stringify(ruta) %>; });
  </script>
  <% } %>
</body>
</html>


